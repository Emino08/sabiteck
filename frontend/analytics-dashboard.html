<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Sabiteck</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav li {
            margin: 10px 0;
        }

        .sidebar nav a {
            color: white;
            text-decoration: none;
            padding: 10px;
            display: block;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: #34495e;
        }

        .main-content {
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            color: #2c3e50;
        }

        .period-selector {
            display: flex;
            gap: 10px;
        }

        .period-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: #007cba;
            color: white;
            border-color: #007cba;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007cba;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-container h3 {
            padding: 20px;
            background: #f8f9fa;
            margin: 0;
            border-bottom: 1px solid #dee2e6;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
        }

        .export-btn:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -250px;
                height: 100%;
                z-index: 1000;
                transition: left 0.3s;
            }

            .charts-grid,
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <h2>Analytics Dashboard</h2>
            <nav>
                <ul>
                    <li><a href="#overview" class="nav-link active">Overview</a></li>
                    <li><a href="#pages" class="nav-link">Pages</a></li>
                    <li><a href="#referrers" class="nav-link">Traffic Sources</a></li>
                    <li><a href="#geography" class="nav-link">Geography</a></li>
                    <li><a href="#devices" class="nav-link">Devices</a></li>
                    <li><a href="#realtime" class="nav-link">Real-time</a></li>
                    <li><a href="#settings" class="nav-link">Settings</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Website Analytics</h1>
                <div>
                    <div class="period-selector">
                        <button class="period-btn" data-period="1d">24h</button>
                        <button class="period-btn" data-period="7d">7d</button>
                        <button class="period-btn active" data-period="30d">30d</button>
                        <button class="period-btn" data-period="90d">90d</button>
                    </div>
                    <a href="#" class="export-btn" onclick="exportReport('csv')">Export CSV</a>
                    <a href="#" class="export-btn" onclick="exportReport('pdf')">Export PDF</a>
                </div>
            </div>

            <!-- Overview Section -->
            <section id="overview" class="dashboard-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="unique-visitors">-</div>
                        <div class="stat-label">Unique Visitors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessions">-</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="page-views">-</div>
                        <div class="stat-label">Page Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bounce-rate">-%</div>
                        <div class="stat-label">Bounce Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-session">-</div>
                        <div class="stat-label">Avg. Session Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-users">-</div>
                        <div class="stat-label">Active Users Now</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Daily Visitors</h3>
                        <canvas id="visitorsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Device Types</h3>
                        <canvas id="devicesChart"></canvas>
                    </div>
                </div>

                <div class="tables-grid">
                    <div class="table-container">
                        <h3>Top Pages</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Views</th>
                                    <th>Visitors</th>
                                </tr>
                            </thead>
                            <tbody id="top-pages">
                                <tr><td colspan="3" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-container">
                        <h3>Traffic Sources</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Type</th>
                                    <th>Sessions</th>
                                </tr>
                            </thead>
                            <tbody id="traffic-sources">
                                <tr><td colspan="3" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Real-time Section -->
            <section id="realtime" class="dashboard-section" style="display: none;">
                <div class="realtime-indicator">
                    <div class="pulse"></div>
                    <span>Live Data</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="realtime-active">-</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3>Active Pages</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Active Users</th>
                                <th>Country</th>
                            </tr>
                        </thead>
                        <tbody id="realtime-pages">
                            <tr><td colspan="3" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Error display -->
            <div id="error-message" class="error" style="display: none;"></div>
        </main>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.apiUrl = '/api/admin/analytics';
                this.currentPeriod = '30d';
                this.refreshInterval = null;
                this.charts = {};

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadDashboard();
                this.startAutoRefresh();
            }

            setupEventListeners() {
                // Period selector
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentPeriod = e.target.dataset.period;
                        this.loadDashboard();
                    });
                });

                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSection(e.target.getAttribute('href').substring(1));
                    });
                });
            }

            async loadDashboard() {
                try {
                    await Promise.all([
                        this.loadStats(),
                        this.loadPopularPages(),
                        this.loadTrafficSources(),
                        this.loadDailyStats(),
                        this.loadDeviceStats()
                    ]);
                } catch (error) {
                    this.showError('Failed to load dashboard data: ' + error.message);
                }
            }

            async loadStats() {
                const response = await this.apiCall(`/dashboard?period=${this.currentPeriod}`);
                const stats = response.data.stats;

                document.getElementById('unique-visitors').textContent = this.formatNumber(stats.unique_visitors || 0);
                document.getElementById('sessions').textContent = this.formatNumber(stats.sessions || 0);
                document.getElementById('page-views').textContent = this.formatNumber(stats.page_views || 0);
                document.getElementById('bounce-rate').textContent = Math.round(stats.bounce_rate || 0) + '%';
                document.getElementById('avg-session').textContent = this.formatDuration(stats.avg_session_duration || 0);
                document.getElementById('active-users').textContent = this.formatNumber(stats.active_users || 0);
            }

            async loadPopularPages() {
                const response = await this.apiCall(`/pages?period=${this.currentPeriod}&limit=10`);
                const pages = response.data.pages;

                const tbody = document.getElementById('top-pages');
                tbody.innerHTML = pages.map(page => `
                    <tr>
                        <td title="${page.page_title || ''}">${this.truncate(page.page_path, 30)}</td>
                        <td>${this.formatNumber(page.page_views)}</td>
                        <td>${this.formatNumber(page.unique_visitors)}</td>
                    </tr>
                `).join('');
            }

            async loadTrafficSources() {
                const response = await this.apiCall(`/referrers?period=${this.currentPeriod}&limit=10`);
                const referrers = response.data.referrers;

                const tbody = document.getElementById('traffic-sources');
                tbody.innerHTML = referrers.map(ref => `
                    <tr>
                        <td>${this.truncate(ref.referrer_domain || 'Direct', 20)}</td>
                        <td><span class="badge">${ref.referrer_type}</span></td>
                        <td>${this.formatNumber(ref.sessions)}</td>
                    </tr>
                `).join('');
            }

            async loadDailyStats() {
                const response = await this.apiCall(`/daily?period=${this.currentPeriod}`);
                const dailyStats = response.data.daily_stats;

                this.updateVisitorsChart(dailyStats);
            }

            async loadDeviceStats() {
                const response = await this.apiCall(`/devices?period=${this.currentPeriod}`);
                const devices = response.data.devices;

                this.updateDevicesChart(devices);
            }

            async loadRealtimeData() {
                const response = await this.apiCall('/realtime');
                const data = response.data;

                document.getElementById('realtime-active').textContent = this.formatNumber(data.total_active_users || 0);

                const tbody = document.getElementById('realtime-pages');
                tbody.innerHTML = data.active_pages.map(page => `
                    <tr>
                        <td>${this.truncate(page.page_url, 30)}</td>
                        <td>${page.count}</td>
                        <td>${page.country || 'Unknown'}</td>
                    </tr>
                `).join('');
            }

            updateVisitorsChart(data) {
                const ctx = document.getElementById('visitorsChart').getContext('2d');

                if (this.charts.visitors) {
                    this.charts.visitors.destroy();
                }

                const labels = data.map(d => new Date(d.date).toLocaleDateString());
                const visitors = data.map(d => d.unique_visitors);
                const pageViews = data.map(d => d.page_views);

                this.charts.visitors = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.reverse(),
                        datasets: [{
                            label: 'Unique Visitors',
                            data: visitors.reverse(),
                            borderColor: '#007cba',
                            backgroundColor: 'rgba(0, 124, 186, 0.1)',
                            fill: true
                        }, {
                            label: 'Page Views',
                            data: pageViews.reverse(),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateDevicesChart(data) {
                const ctx = document.getElementById('devicesChart').getContext('2d');

                if (this.charts.devices) {
                    this.charts.devices.destroy();
                }

                const labels = data.map(d => d.device_type);
                const values = data.map(d => d.visitors);
                const colors = ['#007cba', '#28a745', '#ffc107', '#dc3545'];

                this.charts.devices = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, labels.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            showSection(sectionId) {
                // Hide all sections
                document.querySelectorAll('.dashboard-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Remove active class from nav links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show selected section
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }

                // Add active class to nav link
                document.querySelector(`[href="#${sectionId}"]`).classList.add('active');

                // Load section-specific data
                if (sectionId === 'realtime') {
                    this.loadRealtimeData();
                    this.startRealtimeRefresh();
                } else {
                    this.stopRealtimeRefresh();
                }
            }

            startAutoRefresh() {
                this.refreshInterval = setInterval(() => {
                    this.loadStats();
                }, 60000); // Refresh every minute
            }

            startRealtimeRefresh() {
                this.realtimeInterval = setInterval(() => {
                    this.loadRealtimeData();
                }, 5000); // Refresh every 5 seconds
            }

            stopRealtimeRefresh() {
                if (this.realtimeInterval) {
                    clearInterval(this.realtimeInterval);
                    this.realtimeInterval = null;
                }
            }

            async apiCall(endpoint) {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(this.apiUrl + endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            }

            showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';

                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            formatDuration(seconds) {
                if (seconds < 60) {
                    return Math.round(seconds) + 's';
                } else if (seconds < 3600) {
                    return Math.floor(seconds / 60) + 'm ' + Math.round(seconds % 60) + 's';
                } else {
                    return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
                }
            }

            truncate(str, length) {
                return str.length > length ? str.substring(0, length) + '...' : str;
            }
        }

        // Export functions
        function exportReport(format) {
            const period = document.querySelector('.period-btn.active').dataset.period;
            const token = localStorage.getItem('auth_token');

            const url = `/api/admin/analytics/export?format=${format}&period=${period}&type=overview`;

            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-report-${period}.${format}`;

            // Add authorization header via fetch for download
            fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.blob())
            .then(blob => {
                const downloadUrl = window.URL.createObjectURL(blob);
                a.href = downloadUrl;
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
            })
            .catch(error => {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new AnalyticsDashboard();
        });
    </script>
</body>
</html>