<!DOCTYPE html>
<html>
<head>
    <title>Frontend Auth Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #e7f5e7; }
        .error { background: #ffeaea; }
        button { margin: 5px; padding: 10px; }
        #log { white-space: pre-wrap; background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h1>Frontend Authentication Debug</h1>

    <div class="step">
        <h3>Step 1: Login and Store Token</h3>
        <button onclick="doLogin()">Login as Admin</button>
        <button onclick="checkTokenStorage()">Check Token Storage</button>
    </div>

    <div class="step">
        <h3>Step 2: Test API Headers</h3>
        <button onclick="testHeaders()">Test Headers (Debug Endpoint)</button>
    </div>

    <div class="step">
        <h3>Step 3: Test User Creation</h3>
        <button onclick="testCreateUser()">Create User</button>
    </div>

    <div class="step">
        <h3>Utils</h3>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div id="log"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8002';

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logDiv = document.getElementById('log');
            logDiv.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function clearStorage() {
            localStorage.clear();
            log('LocalStorage cleared');
        }

        async function doLogin() {
            try {
                log('=== ADMIN LOGIN TEST ===');

                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };

                log(`Login request to: ${API_BASE_URL}/api/admin/login`);
                log(`Login data: ${JSON.stringify(loginData)}`);

                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });

                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);

                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);

                if (data.success && data.data && data.data.token) {
                    // Store token like the AuthContext does
                    localStorage.setItem('auth_token', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.user));

                    log(`✅ LOGIN SUCCESS! Token stored: ${data.data.token.substring(0, 20)}...`);
                } else {
                    log(`❌ LOGIN FAILED: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ LOGIN ERROR: ${error.message}`, 'error');
            }
        }

        function checkTokenStorage() {
            log('=== TOKEN STORAGE CHECK ===');

            const authToken = localStorage.getItem('auth_token');
            const adminToken = localStorage.getItem('admin_token');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            log(`auth_token: ${authToken ? authToken.substring(0, 20) + '...' : 'NOT FOUND'}`);
            log(`admin_token: ${adminToken ? adminToken.substring(0, 20) + '...' : 'NOT FOUND'}`);
            log(`token: ${token ? token.substring(0, 20) + '...' : 'NOT FOUND'}`);
            log(`user: ${user ? JSON.parse(user).username : 'NOT FOUND'}`);

            // Simulate what api.js does
            const finalToken = authToken || adminToken || token;
            log(`Final token (api.js logic): ${finalToken ? finalToken.substring(0, 20) + '...' : 'NONE'}`);
        }

        async function testHeaders() {
            try {
                log('=== HEADERS DEBUG TEST ===');

                // Get token like api.js does
                const token = localStorage.getItem('auth_token') ||
                            localStorage.getItem('admin_token') ||
                            localStorage.getItem('token');

                log(`Token found: ${token ? token.substring(0, 20) + '...' : 'NONE'}`);

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                    log(`✅ Authorization header set: Bearer ${token.substring(0, 20)}...`);
                } else {
                    log(`❌ No token - Authorization header NOT set`);
                }

                log(`Headers being sent: ${JSON.stringify(headers, null, 2)}`);

                const response = await fetch(`${API_BASE_URL}/api/debug/headers`, {
                    method: 'GET',
                    headers: headers
                });

                log(`Response status: ${response.status}`);
                log(`Response content-type: ${response.headers.get('content-type')}`);

                const data = await response.json();
                log(`Backend received headers: ${JSON.stringify(data, null, 2)}`);

                if (data.auth_header && data.auth_header !== 'Not present') {
                    log('✅ Backend received Authorization header correctly');
                } else {
                    log('❌ Backend did NOT receive Authorization header', 'error');
                }

            } catch (error) {
                log(`❌ HEADERS TEST ERROR: ${error.message}`, 'error');
            }
        }

        async function testCreateUser() {
            try {
                log('=== USER CREATION TEST ===');

                // Get token like api.js does
                const token = localStorage.getItem('auth_token') ||
                            localStorage.getItem('admin_token') ||
                            localStorage.getItem('token');

                log(`Using token: ${token ? token.substring(0, 20) + '...' : 'NONE'}`);

                if (!token) {
                    log('❌ No token found! Please login first.', 'error');
                    return;
                }

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }

                const userData = {
                    username: 'debuguser_' + Date.now(),
                    email: 'debug_' + Date.now() + '@example.com',
                    first_name: 'Debug',
                    last_name: 'User',
                    role_id: 5
                };

                log(`User data: ${JSON.stringify(userData, null, 2)}`);
                log(`Headers: ${JSON.stringify(headers, null, 2)}`);

                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(userData)
                });

                log(`Response status: ${response.status}`);
                log(`Response content-type: ${response.headers.get('content-type')}`);

                const responseText = await response.text();
                log(`Raw response: ${responseText.substring(0, 500)}...`);

                try {
                    const data = JSON.parse(responseText);
                    log(`Parsed response: ${JSON.stringify(data, null, 2)}`);

                    if (data.success) {
                        log('✅ USER CREATED SUCCESSFULLY!');
                    } else {
                        log(`❌ USER CREATION FAILED: ${data.error}`, 'error');
                    }
                } catch (parseError) {
                    log(`❌ Failed to parse response as JSON: ${parseError.message}`, 'error');
                    log(`This suggests the backend returned HTML instead of JSON`, 'error');
                }

            } catch (error) {
                log(`❌ USER CREATION ERROR: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('Frontend Auth Debug Tool Ready');
        log('Click "Login as Admin" first, then test other features');
    </script>
</body>
</html>