<!DOCTYPE html>
<html>
<head>
    <title>Routes Authorization Fix</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        #log { white-space: pre-wrap; background: #f8f9fa; padding: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üîß Routes Authorization Fix Tool</h1>

    <div class="step info">
        <h3>üìã Current Issue</h3>
        <p>Routes endpoint returns: {"success":false,"error":"No authorization token provided"}</p>
        <p>Users endpoints work fine with the same authentication system.</p>
    </div>

    <div class="step">
        <h3>üîê Step 1: Authentication Setup</h3>
        <button onclick="loginAndStore()">Login & Store Token</button>
        <button onclick="checkStoredAuth()">Check Stored Auth</button>
        <button onclick="clearAuth()">Clear Auth</button>
    </div>

    <div class="step">
        <h3>üß™ Step 2: Test Endpoints</h3>
        <button onclick="testUsersEndpoint()">Test Users (Working)</button>
        <button onclick="testRoutesWithAuth()">Test Routes (Failing)</button>
        <button onclick="testRoutesNoAuth()">Test Routes Debug (No Auth)</button>
    </div>

    <div class="step">
        <h3>üîç Step 3: Debug Headers</h3>
        <button onclick="debugHeaders()">Debug Headers Sent</button>
        <button onclick="simulateFixed()">Simulate Fixed API Call</button>
        <button onclick="testAllVariations()">Test All Route Variations</button>
    </div>

    <div class="step">
        <h3>üéØ Step 4: Apply Fix</h3>
        <button onclick="applyRouteFix()">Apply Same Fix as Users</button>
        <button onclick="testAfterFix()">Test After Fix</button>
    </div>

    <div id="log"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8002';
        let currentToken = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 19);
            const logDiv = document.getElementById('log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'info' ? '‚ÑπÔ∏è' : 'üîç';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            log('Log cleared - Ready for testing');
        }

        async function loginAndStore() {
            log('=== LOGGING IN AND STORING TOKEN ===');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                const data = await response.json();

                if (data.success && data.data && data.data.token) {
                    currentToken = data.data.token;

                    // Store exactly like AuthContext does
                    localStorage.setItem('auth_token', currentToken);
                    localStorage.setItem('user', JSON.stringify(data.data.user));

                    log(`Login successful! Token: ${currentToken.substring(0, 25)}...`, 'success');
                    log(`Token stored in localStorage as 'auth_token'`, 'success');
                } else {
                    log(`Login failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        }

        function checkStoredAuth() {
            log('=== CHECKING STORED AUTHENTICATION ===');

            const authToken = localStorage.getItem('auth_token');
            const adminToken = localStorage.getItem('admin_token');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            log(`auth_token: ${authToken ? authToken.substring(0, 25) + '...' : 'NOT FOUND'}`);
            log(`admin_token: ${adminToken ? adminToken.substring(0, 25) + '...' : 'NOT FOUND'}`);
            log(`token: ${token ? token.substring(0, 25) + '...' : 'NOT FOUND'}`);
            log(`user: ${user ? JSON.parse(user).username : 'NOT FOUND'}`);

            // This mirrors the api.js logic exactly
            const finalToken = authToken || adminToken || token;
            currentToken = finalToken;

            if (finalToken) {
                log(`Final token (api.js logic): ${finalToken.substring(0, 25)}...`, 'success');
                return true;
            } else {
                log('No valid token found!', 'error');
                return false;
            }
        }

        function clearAuth() {
            localStorage.clear();
            currentToken = null;
            log('All authentication cleared', 'info');
        }

        async function testUsersEndpoint() {
            log('=== TESTING USERS ENDPOINT (SHOULD WORK) ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            await testEndpointWithAuth('/api/admin/users-with-roles', 'Users');
        }

        async function testRoutesWithAuth() {
            log('=== TESTING ROUTES ENDPOINT WITH AUTH (CURRENTLY FAILING) ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            await testEndpointWithAuth('/api/admin/routes/all', 'Routes');
        }

        async function testRoutesNoAuth() {
            log('=== TESTING ROUTES DEBUG ENDPOINT (NO AUTH REQUIRED) ===');
            await testEndpointNoAuth('/api/debug/routes', 'Routes Debug');
        }

        async function testEndpointWithAuth(endpoint, name) {
            try {
                // Use the exact same header logic as the fixed api.js
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                };

                if (currentToken) {
                    defaultHeaders.Authorization = `Bearer ${currentToken}`;
                }

                const options = { method: 'GET', headers: {} };

                // Apply the fix we used for user creation/updating
                const mergedHeaders = {
                    ...defaultHeaders,
                    ...(options.headers || {})
                };

                const config = {
                    method: 'GET',
                    ...options,
                    headers: mergedHeaders
                };

                log(`${name} - Sending headers: ${JSON.stringify(config.headers)}`);
                log(`${name} - hasAuthHeader: ${!!config.headers.Authorization}`);

                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const data = await response.json();

                if (data.success) {
                    const count = data.data ? data.data.length : (data.routes ? data.routes.length : 0);
                    log(`${name} - SUCCESS: Got ${count} items`, 'success');
                } else {
                    log(`${name} - FAILED: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`${name} - ERROR: ${error.message}`, 'error');
            }
        }

        async function testEndpointNoAuth(endpoint, name) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                const data = await response.json();

                if (data.success) {
                    const count = data.routes ? data.routes.length : 0;
                    log(`${name} - SUCCESS: Got ${count} routes (no auth required)`, 'success');
                } else {
                    log(`${name} - FAILED: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`${name} - ERROR: ${error.message}`, 'error');
            }
        }

        async function debugHeaders() {
            log('=== DEBUGGING HEADERS SENT TO BACKEND ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                };

                const response = await fetch(`${API_BASE_URL}/api/debug/headers`, {
                    method: 'GET',
                    headers: headers
                });

                const data = await response.json();
                log(`Backend received headers: ${JSON.stringify(data.auth_debug, null, 2)}`);

                if (data.auth_debug && data.auth_debug.HTTP_AUTHORIZATION) {
                    log('Backend correctly received Authorization header', 'success');
                } else {
                    log('Backend did NOT receive Authorization header', 'error');
                }
            } catch (error) {
                log(`Headers debug error: ${error.message}`, 'error');
            }
        }

        async function simulateFixed() {
            log('=== SIMULATING EXACT REACT API CALL WITH FIX ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            // This simulates the exact apiRequest function from api.js with our fix
            const endpoint = '/api/admin/routes/all';
            const options = { method: 'GET' };

            try {
                const url = `${API_BASE_URL}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;

                const defaultHeaders = {
                    'Content-Type': 'application/json',
                };

                // Get token like api.js does
                const token = localStorage.getItem('auth_token') ||
                            localStorage.getItem('admin_token') ||
                            localStorage.getItem('token');

                log(`Token found: ${token ? token.substring(0, 25) + '...' : 'NONE'}`);

                if (token) {
                    defaultHeaders.Authorization = `Bearer ${token}`;
                    log('Added Authorization header to defaultHeaders', 'success');
                } else {
                    log('No token - Authorization header NOT added', 'error');
                    return;
                }

                // Apply the FIXED header merging logic
                const mergedHeaders = {
                    ...defaultHeaders,
                    ...(options.headers || {})
                };

                const config = {
                    method: 'GET',
                    ...options,
                    headers: mergedHeaders  // Headers set AFTER options spread
                };

                log(`Final config: ${JSON.stringify({
                    url: url,
                    method: config.method,
                    hasAuth: token ? 'Bearer ***' : 'No token',
                    hasAuthHeader: !!config.headers.Authorization,
                    authHeaderValue: config.headers.Authorization ? config.headers.Authorization.substring(0, 25) + '...' : 'MISSING'
                })}`);

                const response = await fetch(url, config);
                const data = await response.json();

                if (data.success) {
                    log(`FIXED SIMULATION SUCCESS: Got ${data.routes.length} routes`, 'success');
                } else {
                    log(`FIXED SIMULATION FAILED: ${data.error}`, 'error');
                }

            } catch (error) {
                log(`Simulation error: ${error.message}`, 'error');
            }
        }

        async function testAllVariations() {
            log('=== TESTING ALL ROUTE ENDPOINT VARIATIONS ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            const endpoints = [
                '/api/admin/routes/all',
                '/api/admin/routes',
                '/api/routes',
                '/api/debug/routes'
            ];

            for (const endpoint of endpoints) {
                log(`Testing: ${endpoint}`);
                if (endpoint === '/api/debug/routes' || endpoint === '/api/routes') {
                    await testEndpointNoAuth(endpoint, endpoint);
                } else {
                    await testEndpointWithAuth(endpoint, endpoint);
                }
            }
        }

        function applyRouteFix() {
            log('=== APPLYING SAME FIX AS USER ENDPOINTS ===');
            log('The fix has already been applied to api.js:', 'info');
            log('1. Fixed header merging to prevent Authorization header loss', 'info');
            log('2. Added debugging logs for hasAuthHeader', 'info');
            log('3. Ensured headers are set AFTER options spread', 'info');
            log('4. Added backend logging for routes endpoint', 'info');
            log('Please refresh your React app to load the updated api.js', 'info');
        }

        async function testAfterFix() {
            log('=== TESTING AFTER APPLYING FIX ===');

            if (!checkStoredAuth()) {
                log('Please login first!', 'error');
                return;
            }

            log('Testing both working (users) and previously failing (routes) endpoints:');
            await testUsersEndpoint();
            await testRoutesWithAuth();

            log('If routes still fail, please:');
            log('1. Refresh your React application (Ctrl+F5)');
            log('2. Ensure you are logged in as admin');
            log('3. Check browser console for updated debugging logs');
        }

        // Initialize
        log('üîß Routes Authorization Fix Tool Ready');
        log('Click "Login & Store Token" first, then test the endpoints');

        // Auto-check if already authenticated
        if (localStorage.getItem('auth_token')) {
            log('Found existing auth_token in localStorage');
            checkStoredAuth();
        }
    </script>
</body>
</html>