<!DOCTYPE html>
<html>
<head>
    <title>Exact Login Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 10px 0; padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #log { white-space: pre-wrap; background: #f8f9fa; padding: 15px; border: 1px solid #ddd; margin: 20px 0; max-height: 500px; overflow-y: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        input { margin: 5px; padding: 8px; width: 200px; }
    </style>
</head>
<body>
    <h1>🔍 Exact Frontend Login Test</h1>

    <div>
        <h3>Test Credentials</h3>
        <div>
            Username: <input type="text" id="username" value="admin">
            Password: <input type="password" id="password" value="admin123">
        </div>
        <button onclick="testExactLogin()">🚀 Test Exact Login Flow</button>
        <button onclick="testOtherCredentials()">🔄 Try Other Credentials</button>
        <button onclick="checkCurrentStorage()">📱 Check Storage</button>
        <button onclick="clearStorage()">🗑️ Clear Storage</button>
        <button onclick="clearLog()">🧹 Clear Log</button>
    </div>

    <div id="log"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8002';

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 19);
            const logDiv = document.getElementById('log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Test ready - exact login flow simulation');
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('✅ All storage cleared');
        }

        function checkCurrentStorage() {
            log('=== CURRENT STORAGE STATE ===');

            const authToken = localStorage.getItem('auth_token');
            const user = localStorage.getItem('user');
            const adminToken = localStorage.getItem('admin_token');
            const token = localStorage.getItem('token');

            log(`auth_token: ${authToken ? authToken.substring(0, 20) + '...' : 'NOT SET'}`);
            log(`user: ${user ? JSON.parse(user).username || 'Invalid data' : 'NOT SET'}`);
            log(`admin_token: ${adminToken ? adminToken.substring(0, 20) + '...' : 'NOT SET'}`);
            log(`token: ${token ? token.substring(0, 20) + '...' : 'NOT SET'}`);

            // Check if localStorage is working
            try {
                const testKey = 'test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);

                if (retrieved === 'test_value') {
                    log('✅ localStorage is working correctly', 'success');
                } else {
                    log('❌ localStorage test failed', 'error');
                }
            } catch (error) {
                log(`❌ localStorage error: ${error.message}`, 'error');
            }
        }

        async function testExactLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            log('=== TESTING EXACT FRONTEND LOGIN FLOW ===');
            log(`Attempting login: ${username} / ${password}`);

            try {
                // Step 1: Exactly what Admin.jsx handleLogin does
                const loginForm = { username, password };
                log(`Login form data: ${JSON.stringify(loginForm)}`);

                // Step 2: Make the exact same fetch request
                log('Making fetch request...');
                const res = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginForm)
                });

                log(`Response status: ${res.status}`);
                log(`Response ok: ${res.ok}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(res.headers.entries()))}`);

                // Step 3: Parse response exactly like Admin.jsx
                const data = await res.json().catch(() => ({}));
                log(`Response data: ${JSON.stringify(data, null, 2)}`);

                // Step 4: Check success exactly like Admin.jsx
                if (!res.ok || !data?.success) {
                    const errorMsg = data?.error || data?.message || 'Login failed';
                    log(`❌ LOGIN FAILED: ${errorMsg}`, 'error');
                    return;
                }

                log('✅ Login API call successful!', 'success');
                log(`User data: ${JSON.stringify(data.data.user)}`);
                log(`Token: ${data.data.token.substring(0, 25)}...`);

                // Step 5: Store data exactly like AuthContext login() does
                log('Storing authentication data...');
                localStorage.setItem('auth_token', data.data.token);
                localStorage.setItem('user', JSON.stringify(data.data.user));
                log('✅ Data stored in localStorage', 'success');

                // Step 6: Verify storage
                const storedToken = localStorage.getItem('auth_token');
                const storedUser = localStorage.getItem('user');
                log(`Verification - stored token: ${storedToken ? storedToken.substring(0, 25) + '...' : 'MISSING'}`);
                log(`Verification - stored user: ${storedUser ? JSON.parse(storedUser).username : 'MISSING'}`);

                // Step 7: Test the stored authentication
                await testStoredAuth();

            } catch (error) {
                log(`❌ Network/Parse Error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`);
            }
        }

        async function testStoredAuth() {
            log('\n=== TESTING STORED AUTHENTICATION ===');

            try {
                const storedToken = localStorage.getItem('auth_token');
                if (!storedToken) {
                    log('❌ No stored token found', 'error');
                    return;
                }

                log(`Testing with stored token: ${storedToken.substring(0, 25)}...`);

                // Test with a protected endpoint like the dashboard would
                const authHeaders = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${storedToken}`
                };

                log(`Auth headers: ${JSON.stringify(authHeaders)}`);

                const response = await fetch(`${API_BASE_URL}/api/admin/users-with-roles`, {
                    method: 'GET',
                    headers: authHeaders
                });

                log(`Protected endpoint response: ${response.status}`);
                const data = await response.json();

                if (data.success) {
                    log(`✅ Authentication works! Got ${data.data.length} users`, 'success');
                    log('🎉 Login flow completed successfully!', 'success');
                } else {
                    log(`❌ Protected endpoint failed: ${data.error}`, 'error');
                }

            } catch (error) {
                log(`❌ Auth test error: ${error.message}`, 'error');
            }
        }

        async function testOtherCredentials() {
            log('=== TESTING ALTERNATIVE CREDENTIALS ===');

            const alternatives = [
                { username: 'admin', password: 'admin' },
                { username: 'admin', password: 'password' },
                { username: 'admin', password: '123456' },
                { username: 'abukamara', password: 'admin123' },
                { username: 'emokoro', password: 'admin123' }
            ];

            for (const creds of alternatives) {
                log(`Testing: ${creds.username} / ${creds.password}`);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(creds)
                    });

                    const data = await response.json();
                    if (data.success) {
                        log(`✅ WORKING CREDENTIALS FOUND: ${creds.username} / ${creds.password}`, 'success');
                        document.getElementById('username').value = creds.username;
                        document.getElementById('password').value = creds.password;
                        return;
                    } else {
                        log(`❌ Failed: ${data.error}`);
                    }
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                }
            }

            log('⚠️ No alternative credentials worked');
        }

        // Initialize
        clearLog();
        log('🔍 Exact Frontend Login Test Ready');
        log('This simulates EXACTLY what your React app does');
        log('Click "Test Exact Login Flow" to start');

        // Auto-check storage state
        setTimeout(() => {
            checkCurrentStorage();
        }, 500);
    </script>
</body>
</html>