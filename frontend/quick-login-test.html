<!DOCTYPE html>
<html>
<head>
    <title>Quick Login Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { margin: 10px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        #log { white-space: pre-wrap; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Quick Admin Login Test</h1>
    <button onclick="testLogin()">Test Login (admin/admin123)</button>
    <button onclick="clearLog()">Clear Log</button>
    <div id="log"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8002';

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString().substring(11, 19);
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            log('Log cleared - Ready for testing');
        }

        async function testLogin() {
            log('=== TESTING ADMIN LOGIN ===');

            try {
                log('Step 1: Attempting login with admin/admin123...');

                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                log(`Response status: ${response.status}`);
                log(`Response ok: ${response.ok}`);

                const responseText = await response.text();
                log(`Raw response: ${responseText}`);

                try {
                    const data = JSON.parse(responseText);
                    log(`Parsed data: ${JSON.stringify(data, null, 2)}`);

                    if (data.success) {
                        log('✅ LOGIN SUCCESS!');
                        log(`User: ${data.data.user.username}`);
                        log(`Role: ${data.data.user.role}`);
                        log(`Token: ${data.data.token.substring(0, 20)}...`);

                        // Store like the React app does
                        localStorage.setItem('auth_token', data.data.token);
                        localStorage.setItem('user', JSON.stringify(data.data.user));
                        log('✅ Token stored in localStorage');

                        // Test if token works
                        await testWithToken(data.data.token);

                    } else {
                        log(`❌ LOGIN FAILED: ${data.error}`);
                    }
                } catch (parseError) {
                    log(`❌ JSON Parse Error: ${parseError.message}`);
                }

            } catch (error) {
                log(`❌ Network Error: ${error.message}`);
            }
        }

        async function testWithToken(token) {
            log('\n=== TESTING TOKEN USAGE ===');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users-with-roles`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    log(`✅ Token works! Got ${data.data.length} users`);
                } else {
                    log(`❌ Token test failed: ${data.error}`);
                }

            } catch (error) {
                log(`❌ Token test error: ${error.message}`);
            }
        }

        // Initialize
        clearLog();
        log('Quick Login Test Ready - Click "Test Login" to start');
    </script>
</body>
</html>