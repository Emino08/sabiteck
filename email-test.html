<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        button { padding: 10px; margin: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        input, textarea { width: 300px; padding: 5px; margin: 5px; }
        textarea { height: 100px; }
    </style>
</head>
<body>
    <h1>Email Testing Interface</h1>

    <div class="section">
        <h2>1. Test Email Connection (Database Only)</h2>
        <p><strong>Note:</strong> This test uses email settings stored in the database only (no .env fallbacks)</p>
        <button onclick="testEmailConnection()">Test SMTP Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="section">
        <h2>2. Get Email Settings</h2>
        <button onclick="getEmailSettings()">Get Email Settings</button>
        <div id="settingsResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3. Send Test Email</h2>
        <input type="email" id="testEmail" placeholder="Test email address" value="test@example.com">
        <input type="text" id="testSubject" placeholder="Subject" value="Test Email from Sabiteck">
        <textarea id="testContent" placeholder="Email content">This is a test email from the Sabiteck newsletter system.</textarea>
        <br>
        <button onclick="sendTestEmail()">Send Test Email</button>
        <div id="emailResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002';

        // Login first to get auth token
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('auth_token', data.token);
                    return data.token;
                }
                throw new Error(data.error || 'Login failed');
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            let token = localStorage.getItem('auth_token');

            if (!token) {
                token = await login();
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });

            if (response.status === 401) {
                // Token might be expired, try login again
                token = await login();
                return fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...(options.headers || {})
                    }
                });
            }

            return response;
        }

        async function testEmailConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.textContent = 'Testing connection...';

            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/admin/email/test`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = data.message || 'Connection successful!';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = data.error || 'Connection failed';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        async function getEmailSettings() {
            const resultDiv = document.getElementById('settingsResult');
            resultDiv.textContent = 'Loading settings...';

            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/admin/settings`);
                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '<h3>Email Settings:</h3><pre>' +
                        JSON.stringify(data.settings.email || {}, null, 2) + '</pre>';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = data.error || 'Failed to load settings';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        async function sendTestEmail() {
            const resultDiv = document.getElementById('emailResult');
            const email = document.getElementById('testEmail').value;
            const subject = document.getElementById('testSubject').value;
            const content = document.getElementById('testContent').value;

            if (!email || !subject || !content) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please fill in all fields';
                return;
            }

            resultDiv.textContent = 'Sending email...';

            try {
                // For testing, we'll try to send to a new subscriber
                // First, add the subscriber
                const subscribeResponse = await fetch(`${API_BASE}/api/newsletter/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        name: 'Test User'
                    })
                });

                // Then get the subscriber ID
                const subscribersResponse = await makeAuthenticatedRequest(`${API_BASE}/api/admin/newsletter/subscribers`);
                const subscribersData = await subscribersResponse.json();

                if (subscribersData.success && subscribersData.data && subscribersData.data.length > 0) {
                    const subscriber = subscribersData.data.find(s => s.email === email);
                    if (subscriber) {
                        // Send email to this subscriber
                        const emailResponse = await makeAuthenticatedRequest(`${API_BASE}/api/admin/newsletter/subscribers/${subscriber.id}/email`, {
                            method: 'POST',
                            body: JSON.stringify({
                                subject: subject,
                                content: content
                            })
                        });

                        const emailData = await emailResponse.json();

                        if (emailData.success) {
                            resultDiv.className = 'result success';
                            resultDiv.textContent = 'Email sent successfully to ' + email;
                        } else {
                            resultDiv.className = 'result error';
                            resultDiv.textContent = emailData.error || 'Failed to send email';
                        }
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = 'Subscriber not found';
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Failed to get subscribers';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        // Auto-login on page load
        window.onload = async function() {
            try {
                await login();
                console.log('Auto-login successful');
            } catch (error) {
                console.error('Auto-login failed:', error);
            }
        };
    </script>
</body>
</html>