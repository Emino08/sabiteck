<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Fix Verification</title>
    <style>
        body { font-family: monospace; margin: 20px; background-color: #f5f5f5; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: white; border-radius: 8px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f9f9f9; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .status { padding: 5px 10px; border-radius: 4px; margin: 5px 0; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Admin Dashboard Fix Verification</h1>
    <p class="info">This test verifies that the React object rendering error has been fixed in the admin dashboard.</p>

    <div class="test-section">
        <h3>Test 1: Analytics API Response Structure</h3>
        <button onclick="testAnalyticsAPI()">Test Analytics API</button>
        <div id="analytics-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Dashboard Data Processing</h3>
        <button onclick="testDataProcessing()">Test Data Processing</button>
        <div id="processing-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Number Conversion Safety</h3>
        <button onclick="testNumberConversion()">Test Number Conversion</button>
        <div id="number-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 4: Object Property Access</h3>
        <button onclick="testObjectAccess()">Test Object Access</button>
        <div id="object-result"></div>
    </div>

    <div class="test-section">
        <h3>Fix Summary</h3>
        <div class="status success">
            ✅ Fixed analytics data structure handling
        </div>
        <div class="status success">
            ✅ Added proper type checking for bounce_rate object vs number
        </div>
        <div class="status success">
            ✅ Added Number() conversion for all stats to ensure they're numeric
        </div>
        <div class="status success">
            ✅ Updated analytics fallback data structure to match API response
        </div>
        <p><strong>Root Cause:</strong> The analytics API returns objects like <code>bounce_rate: {rate: 0, growth: 0}</code> but the dashboard was trying to render these objects directly in JSX, causing the "Objects are not valid as a React child" error.</p>
        <p><strong>Solution:</strong> Added proper property extraction and type checking to ensure only primitive values (numbers/strings) are rendered in JSX.</p>
    </div>

    <script>
        async function testAnalyticsAPI() {
            const resultDiv = document.getElementById('analytics-result');
            resultDiv.innerHTML = '<p>Testing analytics API...</p>';

            try {
                const response = await fetch('http://localhost:8002/api/analytics/test/dashboard');
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="status success">✅ Analytics API Response:</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <p><strong>Structure Analysis:</strong></p>
                    <ul>
                        <li>bounce_rate: ${typeof data.bounce_rate} - ${JSON.stringify(data.bounce_rate)}</li>
                        <li>visitors: ${typeof data.visitors} - ${JSON.stringify(data.visitors)}</li>
                        <li>pageviews: ${typeof data.pageviews} - ${JSON.stringify(data.pageviews)}</li>
                    </ul>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }

        function testDataProcessing() {
            const resultDiv = document.getElementById('processing-result');

            // Simulate the analytics API response
            const mockAnalytics = {
                unique_visitors: 100,
                page_views: 500,
                bounce_rate: { rate: 45, growth: 5 },
                visitors: { total: 100, growth: 10 },
                pageviews: { total: 500, growth: 15 }
            };

            // Test the data processing logic from the fix
            const processedStats = {
                uniqueVisitors: Number(typeof mockAnalytics?.unique_visitors === 'number' ? mockAnalytics.unique_visitors : (mockAnalytics?.visitors?.total || 0)),
                pageViews: Number(typeof mockAnalytics?.page_views === 'number' ? mockAnalytics.page_views : (mockAnalytics?.pageviews?.total || 0)),
                bounceRate: Number(typeof mockAnalytics?.bounce_rate === 'number' ? mockAnalytics.bounce_rate : (mockAnalytics?.bounce_rate?.rate || 0))
            };

            resultDiv.innerHTML = `
                <div class="status success">✅ Data Processing Test:</div>
                <p><strong>Input (simulated API response):</strong></p>
                <pre>${JSON.stringify(mockAnalytics, null, 2)}</pre>
                <p><strong>Processed Output (safe for React rendering):</strong></p>
                <pre>${JSON.stringify(processedStats, null, 2)}</pre>
                <p><strong>All values are now primitive numbers ✅</strong></p>
            `;
        }

        function testNumberConversion() {
            const resultDiv = document.getElementById('number-result');

            // Test various edge cases
            const testCases = [
                { input: 42, expected: 42 },
                { input: "42", expected: 42 },
                { input: { rate: 45 }, expected: 0 },
                { input: null, expected: 0 },
                { input: undefined, expected: 0 },
                { input: "not a number", expected: 0 }
            ];

            let results = testCases.map(test => {
                const result = Number(test.input) || 0;
                const passed = result === test.expected;
                return {
                    input: test.input,
                    expected: test.expected,
                    result: result,
                    passed: passed
                };
            });

            const allPassed = results.every(r => r.passed);

            resultDiv.innerHTML = `
                <div class="status ${allPassed ? 'success' : 'error'}">
                    ${allPassed ? '✅' : '❌'} Number Conversion Test: ${allPassed ? 'PASSED' : 'FAILED'}
                </div>
                <table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                    <tr><th>Input</th><th>Expected</th><th>Result</th><th>Status</th></tr>
                    ${results.map(r => `
                        <tr>
                            <td>${JSON.stringify(r.input)}</td>
                            <td>${r.expected}</td>
                            <td>${r.result}</td>
                            <td>${r.passed ? '✅' : '❌'}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        function testObjectAccess() {
            const resultDiv = document.getElementById('object-result');

            // Test the specific object access patterns that were causing the error
            const testData = {
                bounce_rate: { rate: 45, growth: 5 },
                unique_visitors: 100,
                visitors: { total: 150, growth: 10 }
            };

            const safeAccess = {
                // Old (problematic) way: would render the object
                // bounce_rate: testData.bounce_rate

                // New (fixed) way: extract the primitive value
                bounceRate: typeof testData?.bounce_rate === 'number' ? testData.bounce_rate : (testData?.bounce_rate?.rate || 0),
                uniqueVisitors: typeof testData?.unique_visitors === 'number' ? testData.unique_visitors : (testData?.visitors?.total || 0)
            };

            resultDiv.innerHTML = `
                <div class="status success">✅ Object Access Test:</div>
                <p><strong>Test Data:</strong></p>
                <pre>${JSON.stringify(testData, null, 2)}</pre>
                <p><strong>Safe Property Access (React-safe values):</strong></p>
                <pre>${JSON.stringify(safeAccess, null, 2)}</pre>
                <p><strong>Types:</strong></p>
                <ul>
                    <li>bounceRate: ${typeof safeAccess.bounceRate} (${safeAccess.bounceRate})</li>
                    <li>uniqueVisitors: ${typeof safeAccess.uniqueVisitors} (${safeAccess.uniqueVisitors})</li>
                </ul>
                <p class="success">All extracted values are primitive types safe for React rendering! ✅</p>
            `;
        }

        // Auto-run tests on page load
        window.onload = function() {
            console.log('Admin Dashboard Fix Verification loaded');
        };
    </script>
</body>
</html>